<!DOCTYPE html>
<html class="h-full bg-gray-50" lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Whatsapp Venom</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/id.min.js" integrity="sha512-he8U4ic6kf3kustvJfiERUpojM8barHoz0WYpAUDWQVn61efpm3aVAD8RWL8OloaDDzMZ1gZiubF9OSdYBqHfQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Alpine Core -->
    <script defer src="https://unpkg.com/alpinejs@3.9.1/dist/cdn.min.js"></script>
    <style>
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="h-full overflow-hidden bg-slate-50" x-data="{ instance: $store.instance }">
<div class="flex min-h-full items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="w-full max-w-md rounded-md bg-white shadow-lg border border-gray-200">
        <div class="flex items-center justify-between border-b border-gray-200 bg-white px-4 py-3 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-indigo-700" >
                Whatsapp Notification Service
            </h3>
        </div>
        <div class="flex flex-col items-center justify-between border-b border-gray-200 bg-white px-4 py-3 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900" >
                <span>Current Status : </span>
                <span x-text="$store.instance.status"> Mohon tunggu... </span>
            </h3>
            <p class='mt-2 text-underline'>
                Lihat <a class='decoration-underline text-indigo-600' href='https://docs.orkestral.io/venom/#/?id=connection-status-returns' target='_blank'> dokumentasi status </a>
            </p>
        </div>
        <div class="flex items-center justify-between border-b border-gray-200 bg-white px-4 py-3 sm:px-6"
             x-data="{ open: $store.instance.showQr,
             isOpen() { return open && !(['isLogged','qrReadSuccess','chatsAvailable','waitChat','successChat'].includes($store.instance.status));}}"
             x-init="$watch('$store.instance.showQr', function(v) { open = v });"
             x-show="isOpen()"
        >
            <div class="mt-3 text-center sm:mt-5">
                <h3 class="text-lg leading-6 font-medium text-gray-900" >
                    <span x-show="$store.instance.showQr"> Scan QRCode </span>
                </h3>
                <div class="mt-6">
                    <div x-show="isOpen()" class="flex items-center justify-center">
                        <img class="p-4" src="" alt="" id="qrcode_box" width="250" height="250" x-bind:src="$store.instance.qr" />
                    </div>
                </div>
            </div>
        </div>
        <div class="flex items-center justify-between bg-white px-4 py-3 sm:px-6">
            <div class='flex space-4'>
                <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                        @click.prevent="async () => {  await $store.instance.restart(); }"
                >
                    Restart Session
                </button>


            </div>
        </div>
    </div>
</div>

<script>
    moment().locale('id');

    // Enable pusher logging - don't include this in production
    // Pusher.logToConsole = true;

    const pusher = new Pusher('b7a876361e7302db1cab', {
        cluster: 'ap1'
    });

    const channel = pusher.subscribe('whatsapp');

    document.addEventListener('alpine:init', () => {
        Alpine.store('instance', {
            token: '<%= token %>',
            selected: '',
            loading: true,
            showQr: false,
            qr: '',            
            chats: [],
            groups: [],
            messages: [],
            archives: [],
            contact: {}, //
            status: '<%= status %>',
            
            init() {
                this.socketHandler()
                this.loading = false
            },
            async restart() {
                const res = await ( await fetch('/instance/init')).json();
            },
            socketHandler() {
                const that = this

                channel.bind('instance-status', function ( data ) {
                    that.status = data.status
                })

                channel.bind('instance-qr', function ( data ) {
                    that.qr = data.qr
                    that.showQr = true

                    console.log('receive qr')
                })
            },
            ev(name, detail) {
                window.dispatchEvent(
                    new CustomEvent(name, {
                        detail,
                        bubbles: true,
                        // Allows events to pass the shadow DOM barrier.
                        composed: true,
                        cancelable: true,
                    })
                )
            }
        })
    })
</script>
</body>
</html>